---
phase: 01-interface-abstraction
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/feishu/client.go
  - internal/feishu/ws_receiver.go
autonomous: true

must_haves:
  truths:
    - "client.go 重命名为 ws_receiver.go"
    - "Client 结构体内嵌 RESTSender 而非重复 SendMessage 等方法"
    - "Client 实现 FeishuReceiver 接口"
    - "WebSocket 消息接收功能保持不变"
  artifacts:
    - path: "internal/feishu/ws_receiver.go"
      provides: "WebSocket 模式的 Client 实现"
      exports: ["Client", "NewClient"]
      contains: "RESTSender"
  key_links:
    - from: "internal/feishu/ws_receiver.go"
      to: "internal/feishu/sender.go"
      via: "RESTSender embedding"
      pattern: "\\*RESTSender"
    - from: "internal/feishu/ws_receiver.go"
      to: "internal/feishu/receiver.go"
      via: "interface implementation"
      pattern: "func \\(c \\*Client\\) Start"
---

<objective>
重构现有 client.go 为 ws_receiver.go，实现接口并内嵌 RESTSender。

Purpose: 让 WebSocket 模式的 Client 符合新接口定义，消除重复代码
Output: ws_receiver.go 替代 client.go，实现 FeishuReceiver 并内嵌 RESTSender
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md

# 依赖的前置计划
@.planning/phases/01-interface-abstraction/01-01-SUMMARY.md

# 需要重构的文件
@internal/feishu/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: 重构 Client 结构体内嵌 RESTSender</name>
  <files>internal/feishu/client.go</files>
  <action>
修改 `internal/feishu/client.go`：

1. 删除 MessageHandler 类型定义（已移至 receiver.go）

2. 修改 Client 结构体，内嵌 RESTSender：
   ```go
   type Client struct {
       *RESTSender          // 内嵌 RESTSender，自动获得 SendMessage/UpdateMessage/DeleteMessage
       appID     string
       appSecret string
       wsClient  *larkws.Client
       handler   MessageHandler
   }
   ```

3. 修改 NewClient 构造函数：
   ```go
   func NewClient(appID, appSecret string, handler MessageHandler) *Client {
       return &Client{
           RESTSender: NewRESTSender(appID, appSecret),
           appID:      appID,
           appSecret:  appSecret,
           handler:    handler,
       }
   }
   ```

4. 删除以下方法（现在由内嵌的 RESTSender 提供）：
   - SendMessage
   - UpdateMessage
   - DeleteMessage

5. 删除 escapeJSON 辅助函数（已移至 sender.go）

6. 删除 client 字段（原 *lark.Client，现在由 RESTSender 管理）

7. 添加接口合规性检查：
   ```go
   var _ FeishuSender = (*Client)(nil)
   var _ FeishuReceiver = (*Client)(nil)
   ```

8. 更新 import，移除不再需要的：
   - 移除直接的 lark 导入（RESTSender 内部使用）
   - 保留 larkws、dispatcher、larkim（WebSocket 事件处理需要）
  </action>
  <verify>
- 语法检查：`go build ./internal/feishu/...`
- 接口检查：`grep "var _ FeishuSender" internal/feishu/client.go`
- 内嵌检查：`grep "\\*RESTSender" internal/feishu/client.go`
  </verify>
  <done>
- Client 内嵌 RESTSender
- 删除重复的 SendMessage/UpdateMessage/DeleteMessage 方法
- Client 实现 FeishuSender 和 FeishuReceiver 接口
  </done>
</task>

<task type="auto">
  <name>Task 2: 重命名 client.go 为 ws_receiver.go</name>
  <files>internal/feishu/client.go, internal/feishu/ws_receiver.go</files>
  <action>
使用 git mv 重命名文件：

```bash
git mv internal/feishu/client.go internal/feishu/ws_receiver.go
```

文件内容已在 Task 1 中修改，此任务仅执行重命名。

重命名后验证：
1. 文件路径正确
2. git 识别为重命名而非删除+新增
3. 编译仍然成功
  </action>
  <verify>
- 文件存在：`ls internal/feishu/ws_receiver.go`
- 旧文件不存在：`! ls internal/feishu/client.go 2>/dev/null`
- git 状态：`git status --short | grep ws_receiver`
- 编译成功：`go build ./...`
  </verify>
  <done>
- client.go 重命名为 ws_receiver.go
- git 正确追踪重命名
- 项目编译成功
  </done>
</task>

</tasks>

<verification>
```bash
# 1. 文件结构正确
ls -la internal/feishu/*.go

# 2. 全项目编译
go build ./...

# 3. 接口实现验证
grep -E "var _ (FeishuSender|FeishuReceiver)" internal/feishu/ws_receiver.go

# 4. 内嵌验证
grep "\\*RESTSender" internal/feishu/ws_receiver.go
```
</verification>

<success_criteria>
- [ ] client.go 重命名为 ws_receiver.go
- [ ] Client 内嵌 RESTSender
- [ ] Client 实现 FeishuReceiver 接口
- [ ] 无重复的 SendMessage/UpdateMessage/DeleteMessage 方法
- [ ] `go build ./...` 成功
</success_criteria>

<output>
After completion, create `.planning/phases/01-interface-abstraction/01-02-SUMMARY.md`
</output>
