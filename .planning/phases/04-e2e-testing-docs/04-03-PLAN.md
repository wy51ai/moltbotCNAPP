---
phase: 04-e2e-testing-docs
plan: 03
type: execute
wave: 2
depends_on:
  - "04-01"
  - "04-02"
files_modified:
  - README.md
autonomous: true

must_haves:
  truths:
    - "用户能通过 README 自助配置 Webhook 模式"
    - "配置字段说明清晰，含默认值"
    - "常见问题有排查指南"
    - "去重机制 (event_id) 有说明"
  artifacts:
    - path: "README.md"
      provides: "Webhook configuration documentation"
      contains: "Webhook 模式"
  key_links:
    - from: "README.md"
      to: "bridge.json"
      via: "JSON 配置示例"
      pattern: "verification_token"
---

<objective>
更新 README 文档，添加 Webhook 模式配置说明、飞书后台配置指南和常见问题排查。

Purpose: 用户需要文档指导才能正确配置 Webhook 模式。Codex 评审要求明确说明去重使用 event_id 及原因。

Output:
- README.md 新增 Webhook 模式章节
- 配置字段表格 + 完整 JSON 示例
- 飞书后台配置说明
- 常见问题 FAQ
- ngrok 手动验收 runbook
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-e2e-testing-docs/04-CONTEXT.md

# 文档结构决策 (CONTEXT.md):
# - Webhook 配置说明放在 README 新增章节
# - 配置示例用表格说明字段 + 完整 JSON 示例

@README.md
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Webhook 配置章节</name>
  <files>README.md</files>
  <action>
在 README.md "可选参数" 章节后新增 "## Webhook 模式" 章节:

```markdown
## Webhook 模式

除了默认的 WebSocket 长连接模式，Bridge 还支持 Webhook 回调模式。Webhook 模式适用于:
- 无法建立出站 WebSocket 连接的环境
- 需要部署在公网可访问服务器的场景
- 飞书应用使用"事件订阅"而非"长连接"的配置

### 配置说明

在 `~/.clawdbot/bridge.json` 中设置 `mode` 为 `"webhook"`:

| 字段 | 说明 | 必填 | 默认值 |
|------|------|------|--------|
| `mode` | 运行模式 | 否 | `"websocket"` |
| `webhook.port` | HTTP 服务端口 | 否 | `9090` |
| `webhook.path` | Webhook 路径 | 否 | `"/webhook/feishu"` |
| `webhook.verification_token` | 飞书验证 Token | **是** | — |
| `webhook.encrypt_key` | 飞书加密密钥 | **是** | — |
| `webhook.workers` | Worker 并发数 | 否 | `10` |
| `webhook.queue_size` | 任务队列大小 | 否 | `100` |

### 完整配置示例

```json
{
  "mode": "webhook",
  "feishu": {
    "app_id": "cli_xxx",
    "app_secret": "your_app_secret"
  },
  "webhook": {
    "port": 9090,
    "path": "/webhook/feishu",
    "verification_token": "your_verification_token_from_feishu",
    "encrypt_key": "your_encrypt_key_from_feishu"
  }
}
```

### 启动 Webhook 模式

```bash
# 首次配置
./clawdbot-bridge start mode=webhook

# 之后直接启动 (读取配置文件)
./clawdbot-bridge start
```
```
  </action>
  <verify>README.md 包含 "## Webhook 模式" 章节和配置表格</verify>
  <done>Webhook 配置章节完成，含字段表格和 JSON 示例</done>
</task>

<task type="auto">
  <name>Task 2: 飞书后台配置说明</name>
  <files>README.md</files>
  <action>
在 Webhook 模式章节后新增飞书配置指南:

```markdown
### 飞书后台配置

1. **获取凭据**
   - 登录 [飞书开放平台](https://open.feishu.cn/)
   - 进入你的应用 -> 凭证与基础信息
   - 复制 `App ID` 和 `App Secret`

2. **配置事件订阅**
   - 进入 事件订阅 -> 事件配置
   - 请求地址: `https://your-domain.com:9090/webhook/feishu`
     (需要公网可访问，可用 ngrok 测试)
   - 复制 `Verification Token` 和 `Encrypt Key` 到配置文件

3. **添加事件**
   - 点击 "添加事件"
   - 搜索并添加 `接收消息 im.message.receive_v1`

4. **权限配置**
   - 进入 权限管理
   - 开启以下权限:
     - `im:message` - 获取与发送单聊、群组消息
     - `im:message.group_at_msg` - 接收群聊中 @ 机器人消息
     - `im:message.p2p_msg` - 接收用户发给机器人的单聊消息

5. **发布应用**
   - 进入 版本管理与发布 -> 创建版本 -> 申请发布
```
  </action>
  <verify>README.md 包含飞书后台配置的 5 个步骤</verify>
  <done>飞书后台配置说明完成</done>
</task>

<task type="auto">
  <name>Task 3: FAQ 和 ngrok 验收指南</name>
  <files>README.md</files>
  <action>
在飞书配置章节后新增 FAQ 和 ngrok 指南:

```markdown
### 使用 ngrok 测试

本地开发时可用 ngrok 暴露服务:

```bash
# 安装 ngrok (macOS)
brew install ngrok

# 启动隧道
ngrok http 9090

# 复制 Forwarding URL (如 https://xxxx.ngrok.io)
# 在飞书后台配置为: https://xxxx.ngrok.io/webhook/feishu
```

**验收步骤:**
1. 启动 Bridge: `./clawdbot-bridge run mode=webhook`
2. 启动 ngrok: `ngrok http 9090`
3. 在飞书后台配置 Webhook URL
4. 点击 "验证" 按钮，应看到 `[Webhook] Challenge verified successfully` 日志
5. 在飞书发送消息给机器人，验证收发正常

### 常见问题

**Q: 启动报错 "webhook.verification_token is required"**

A: Webhook 模式需要配置验证 Token 和加密密钥。从飞书开放平台 -> 事件订阅获取这两个值，添加到 `~/.clawdbot/bridge.json`。

**Q: 飞书验证 Webhook URL 失败**

A: 检查以下几点:
1. 确保服务已启动且端口可访问
2. URL 路径默认是 `/webhook/feishu`，注意不要漏掉
3. 检查 `verification_token` 是否正确 (从飞书后台复制)
4. 如使用 ngrok，确保隧道正在运行

**Q: 收到消息但没有响应**

A: 检查日志中是否有错误:
- `event=queue_full`: 队列满，增加 `webhook.queue_size`
- `event=duplicate`: 重复事件被忽略 (正常，10分钟内相同 event_id 会去重)
- 检查 ClawdBot Gateway 是否正在运行

**Q: 为什么使用 event_id 而不是 message_id 去重？**

A: 飞书可能对同一消息重试多次 (网络超时等)，每次重试的 `event_id` 相同但可能触发多次处理。使用 `event_id` 去重可以确保:
1. 同一事件只处理一次
2. 即使飞书重试也不会重复处理
3. TTL 为 10 分钟，覆盖飞书最长重试周期

### 监控指标

Webhook 模式提供 Prometheus 指标，访问 `http://localhost:9090/metrics`:

| 指标 | 类型 | 说明 |
|------|------|------|
| `feishu_webhook_requests_total` | Counter | 请求总数 (按 status 分类) |
| `feishu_webhook_request_duration_seconds` | Histogram | HTTP 请求耗时 |
| `feishu_message_processing_duration_seconds` | Histogram | 消息处理耗时 |
| `feishu_webhook_signature_failures_total` | Counter | 签名验证失败次数 |
| `feishu_worker_queue_depth` | Gauge | 当前队列深度 |
| `feishu_worker_queue_capacity` | Gauge | 队列容量 |

健康检查: `curl http://localhost:9090/health`
```
  </action>
  <verify>README.md 包含 FAQ 章节、ngrok 验收指南、监控指标表格</verify>
  <done>FAQ、ngrok 指南、监控指标文档完成</done>
</task>

</tasks>

<verification>
- README.md 结构清晰，包含完整 Webhook 文档
- 配置字段表格准确
- 飞书后台配置步骤可操作
- FAQ 覆盖常见问题
- ngrok 验收步骤可执行
</verification>

<success_criteria>
- [ ] Webhook 模式章节存在，含配置表格
- [ ] 完整 JSON 配置示例正确
- [ ] 飞书后台配置指南完整 (5 步)
- [ ] FAQ 至少 4 个问答
- [ ] event_id 去重原因有说明
- [ ] ngrok 验收步骤清晰
- [ ] 监控指标表格完整
</success_criteria>

<output>
After completion, create `.planning/phases/04-e2e-testing-docs/04-03-SUMMARY.md`
</output>
